{% extends "base.html" %}
{% block content %}
<h2>Job #{{ object.id }}</h2>

<p>
  Program:
  <a href="{% url 'program_detail' object.program.pk %}">
    {{ object.program.part_no }} {{ object.program.revision }}
  </a><br>
  Machine: {{ object.machine.name }} •
  Material: {{ object.material.name }}<br>
  Qty: {{ object.qty }} •
  WCS: {{ object.wcs }} •
  Status: <strong>{{ object.get_status_display }}</strong>
</p>

{% if request.user.id == object.owner_id %}
<div style="display:flex;gap:.5rem;flex-wrap:wrap;margin:.5rem 0">
  <a class="btn" href="{% url 'job_edit' object.pk %}">Edit</a>
  <form method="post" action="{% url 'job_delete' object.pk %}" style="display:inline">
    {% csrf_token %}
    <button class="btn" style="background:#ef4444" onclick="return confirm('Delete this job?')">
      Delete
    </button>
  </form>
  {% if object.status == "draft" %}
    <a class="btn" href="{% url 'job_submit' object.pk %}">Submit</a>
  {% elif object.status == "submitted" %}
    <a class="btn" href="{% url 'job_approve' object.pk %}">Approve</a>
  {% endif %}
  <a class="btn" href="{% url 'job_packet' object.pk %}">View Packet</a>
  <a class="btn" href="{% url 'job_packet_pdf' object.pk %}">Download PDF</a>
</div>
{% endif %}

<h3>Run Log</h3>
{% if logs %}
  <ul>
    {% for r in logs %}
      <li>
        {{ r.ts|date:"Y-m-d H:i" }} —
        {{ r.user.username }} —
        {{ r.action }}
        {% if r.notes %} — {{ r.notes }}{% endif %}
      </li>
    {% endfor %}
  </ul>
{% else %}
  <p>No activity yet.</p>
{% endif %}

{% if lint_results %}
  <h3>Lint Warnings</h3>
  <ul>
    {% if lint_results.error %}
      <li style="color:red;">Error parsing program: {{ lint_results.error }}</li>
    {% else %}
      {% for lint in lint_results.lints %}
        <li>
          <strong>[{{ lint.sev|upper }}]</strong>
          {{ lint.code }} — {{ lint.msg }}
        </li>
      {% empty %}
        <li>No lint issues found ✅</li>
      {% endfor %}
    {% endif %}
  </ul>
{% endif %}

<h3>Ask AI about this program</h3>

<style>
  .ai-row { display:flex; align-items:center; gap:.75rem; margin:.5rem 0; }
  .ai-status { display:none; align-items:center; gap:.5rem; font-size:.95rem; opacity:.8; }
  .ai-status.on { display:inline-flex; }
  .loader {
    width:1em; height:1em; border:.15em solid currentColor; border-right-color:transparent;
    border-radius:50%; animation:ai-spin .8s linear infinite;
  }
  @keyframes ai-spin { to { transform: rotate(360deg); } }
  .dots { display:inline-block; overflow:hidden; vertical-align:bottom; width:0ch; }
  .dots.on { animation: ai-dots 1.2s steps(4,end) infinite; }
  @keyframes ai-dots { 0% { width:0ch; } 100% { width:3ch; } }
  .ai-output { white-space:pre-wrap; margin-top:.5rem; }
</style>

<textarea id="ai-q" rows="4" style="width:100%"
  placeholder="Ask about feeds, safe Z, WCS, toolpath risks…"></textarea>

<div class="ai-row">
  <button id="ai-ask-btn" class="btn" type="button">Ask</button>
  <div id="ai-status" class="ai-status">
    <span class="loader"></span>
    <span>Generating<span id="ai-dots" class="dots">...</span></span>
  </div>
</div>

<pre id="ai-ans" class="ai-output"></pre>

<script>
// CSRF helper (Django)
function getCookie(name) {
  const m = document.cookie.match('(^|;)\\s*' + name + '\\s*=\\s*([^;]+)');
  return m ? m.pop() : '';
}

async function aiAsk() {
  const btn   = document.getElementById('ai-ask-btn');
  const box   = document.getElementById('ai-status');
  const dots  = document.getElementById('ai-dots');
  const out   = document.getElementById('ai-ans');
  const q     = document.getElementById('ai-q').value.trim();
  if (!q) return;

  // UI: show loader
  btn.disabled = true;
  out.textContent = '';
  box.classList.add('on');
  dots.classList.add('on');

  try {
    const resp = await fetch("{% url 'ai_chat_for_program' object.program_id %}", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "X-CSRFToken": getCookie('csrftoken')
      },
      body: JSON.stringify({ prompt: q })
    });
    const data = await resp.json();
    out.textContent = data.reply || data.error || "(no reply)";
  } catch (e) {
    out.textContent = "Error: " + (e?.message || e);
  } finally {
    // UI: hide loader
    box.classList.remove('on');
    dots.classList.remove('on');
    btn.disabled = false;
  }
}

document.getElementById('ai-ask-btn').addEventListener('click', aiAsk);
</script>

<h3>Attachments</h3>
{% if attachments %}
  <ul>
    {% for att in attachments %}
      <li>
        <a href="{% url 'attachment_download' att.pk %}">{{ att.file.name|basename }}</a>
        (uploaded by {{ att.uploaded_by.username }} on {{ att.uploaded_at|date:"Y-m-d H:i" }})
        {% if request.user.id == object.owner_id %}
          — <a href="{% url 'attachment_delete' att.pk %}" style="color:red"
               onclick="return confirm('Delete this attachment?')">Delete</a>
        {% endif %}
      </li>
    {% endfor %}
  </ul>
{% else %}
  <p>No attachments yet.</p>
{% endif %}

{% if request.user.id == object.owner_id %}
  <h4>Upload Attachment</h4>
  <form method="post" enctype="multipart/form-data" action="{% url 'attachment_add' object.pk %}">
    {% csrf_token %}
    {{ attachment_form.file }}
    <button type="submit" class="btn">Upload</button>
  </form>
{% endif %}
{% endblock %}